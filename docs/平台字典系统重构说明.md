# 平台字典系统重构完成说明

## 已完成的后端改动

### 1. 新增 PlatformDict 实体和 API
- ✅ 创建 `PlatformDict` 实体 (entity/PlatformDict.java)
- ✅ 创建 `PlatformDictDao` (dao/PlatformDictDao.java)
- ✅ 创建 `PlatformDictService` 和实现 (service/PlatformDictService.java)
- ✅ 创建 `PlatformDictController` (controller/PlatformDictController.java)
- ✅ 创建 DTO: `PlatformDictAdd`, `PlatformDictEdit`
- ✅ 添加路径验证，禁止 `admin` 和 `/` (根路径)

### 2. 更新 Navigation 实体
- ✅ 将 `showPlatform` 从 `Integer` 改为 `String`
- ✅ 存储格式：逗号分隔的 routePath，如 "dev,cp,public"
- ✅ 新增辅助方法：`getShowPlatformList()` 和 `setShowPlatformFromList()`

### 3. 更新 SitePublish 实体
- ✅ 将 `showPlatform` (Integer) 改为 `platformDictPath` (String)
- ✅ 直接引用 PlatformDict 的 routePath
- ✅ 添加路径验证方法 `isReservedPath()`

## 已完成的前端改动

### 1. 类型定义更新 (types/index.ts)
- ✅ `NavItem.showPlatform` 改为 `string` 类型
- ✅ 新增 `PlatformDict`, `PlatformDictAdd`, `PlatformDictEdit` 类型
- ✅ 更新 `SitePublish` 相关类型，使用 `platformDictPath`

### 2. API 更新 (services/api.ts)
- ✅ 新增 `platformDictApi` 完整 CRUD 接口
- ✅ 更新 `navigationApi.getListByPlatform()` 参数为字符串数组

## 需要完成的前端组件

### 1. 创建平台字典管理组件

创建文件: `reactWeb/src/pages/Admin/components/PlatformDictManagement.tsx`

```typescript
import React, { useState, useEffect } from 'react';
import { Table, Button, Modal, Form, Input, Switch, Popconfirm, Space, App, Tag } from 'antd';
import { Plus, Edit, Trash2, Globe } from 'lucide-react';
import type { PlatformDict } from '@/types';
import { platformDictApi } from '@/services/api';

const PlatformDictManagement: React.FC = () => {
  const { message } = App.useApp();
  const [platformList, setPlatformList] = useState<PlatformDict[]>([]);
  const [loading, setLoading] = useState(false);
  const [modalVisible, setModalVisible] = useState(false);
  const [editingItem, setEditingItem] = useState<PlatformDict | null>(null);
  const [form] = Form.useForm();

  const loadData = async () => {
    setLoading(true);
    try {
      const response = await platformDictApi.getList();
      if (response.code === 200 && response.data) {
        setPlatformList(response.data);
      }
    } catch (error) {
      console.error('加载平台字典失败:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadData();
  }, []);

  const handleAdd = () => {
    setEditingItem(null);
    form.resetFields();
    form.setFieldsValue({ enabled: true, sort: 1 });
    setModalVisible(true);
  };

  const handleEdit = (item: PlatformDict) => {
    setEditingItem(item);
    form.setFieldsValue(item);
    setModalVisible(true);
  };

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();

      if (editingItem) {
        await platformDictApi.update({ ...values, id: editingItem.id });
        message.success('更新成功');
      } else {
        await platformDictApi.create(values);
        message.success('添加成功');
      }

      setModalVisible(false);
      loadData();
    } catch (error: any) {
      if (error.errorFields) return;
      console.error('操作失败:', error);
    }
  };

  const handleDelete = async (id: number) => {
    try {
      await platformDictApi.delete(id);
      message.success('删除成功');
      loadData();
    } catch (error) {
      console.error('删除失败:', error);
    }
  };

  const columns = [
    {
      title: '路由路径',
      dataIndex: 'routePath',
      key: 'routePath',
      width: 120,
      render: (path: string) => <code className="bg-gray-100 px-2 py-1 rounded">{path}</code>,
    },
    {
      title: '平台名称',
      dataIndex: 'platformName',
      key: 'platformName',
      width: 150,
    },
    {
      title: '状态',
      dataIndex: 'enabled',
      key: 'enabled',
      width: 80,
      render: (value: boolean) => (
        <Tag color={value ? 'success' : 'default'}>{value ? '启用' : '禁用'}</Tag>
      ),
    },
    {
      title: '排序',
      dataIndex: 'sort',
      key: 'sort',
      width: 60,
    },
    {
      title: '描述',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
    },
    {
      title: '操作',
      key: 'action',
      width: 150,
      fixed: 'right' as const,
      render: (_: any, record: PlatformDict) => (
        <Space>
          <Button
            type="link"
            size="small"
            icon={<Edit className="w-3 h-3" />}
            onClick={() => handleEdit(record)}
          >
            编辑
          </Button>
          <Popconfirm
            title="确认删除"
            description="删除后相关配置将受影响，确定删除吗？"
            onConfirm={() => handleDelete(record.id!)}
            okText="确认"
            cancelText="取消"
          >
            <Button
              type="link"
              danger
              size="small"
              icon={<Trash2 className="w-3 h-3" />}
            >
              删除
            </Button>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  return (
    <div className="h-full flex flex-col">
      <div className="flex justify-between items-center mb-4">
        <div>
          <h2 className="text-xl font-semibold flex items-center gap-2">
            <Globe className="w-5 h-5" />
            平台字典管理
          </h2>
          <p className="text-sm text-gray-500 mt-1">
            管理平台路由和名称，用于导航分组和页面发布
          </p>
        </div>
        <Button
          type="primary"
          icon={<Plus className="w-4 h-4" />}
          onClick={handleAdd}
        >
          新增平台
        </Button>
      </div>

      <Table
        columns={columns}
        dataSource={platformList}
        rowKey="id"
        loading={loading}
        pagination={{
          pageSize: 10,
          showSizeChanger: true,
          showTotal: (total) => `共 ${total} 条`,
        }}
      />

      <Modal
        title={editingItem ? '编辑平台字典' : '新增平台字典'}
        open={modalVisible}
        onOk={handleSubmit}
        onCancel={() => setModalVisible(false)}
        width={600}
        destroyOnClose
      >
        <Form form={form} layout="vertical" autoComplete="off">
          <Form.Item
            label="路由路径"
            name="routePath"
            rules={[
              { required: true, message: '请输入路由路径' },
              { pattern: /^[a-zA-Z0-9-_]+$/, message: '只能包含字母、数字、横杠和下划线' },
            ]}
            tooltip="不包含前缀斜杠，不允许使用 admin 和根路径"
          >
            <Input placeholder="dev" disabled={!!editingItem} />
          </Form.Item>

          <Form.Item
            label="平台名称"
            name="platformName"
            rules={[{ required: true, message: '请输入平台名称' }]}
          >
            <Input placeholder="开发运维平台" />
          </Form.Item>

          <Form.Item label="描述说明" name="description">
            <Input.TextArea rows={3} placeholder="描述该平台的用途" />
          </Form.Item>

          <Form.Item label="启用状态" name="enabled" valuePropName="checked">
            <Switch checkedChildren="启用" unCheckedChildren="禁用" />
          </Form.Item>

          <Form.Item label="排序" name="sort" rules={[{ required: true, message: '请输入排序值' }]}>
            <Input type="number" min={1} />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default PlatformDictManagement;
```

### 2. 更新 AdminSidebar

在 `components/AdminSidebar/index.tsx` 中添加��台字典菜单项：

```typescript
const menuItems = [
  { key: 'nav-management', icon: <Navigation />, label: '导航管理' },
  { key: 'category-management', icon: <Bookmark />, label: '分类管理' },
  { key: 'platform-dict-management', icon: <Globe />, label: '平台字典' }, // 新增
  { key: 'site-publish-management', icon: <Globe />, label: '页面发布' },
  { key: 'system-management', icon: <Settings />, label: '系统配置' },
  { key: 'backup-management', icon: <Database />, label: '备份管理' },
];
```

### 3. 更新 Admin/index.tsx

添加平台字典管理 tab：

```typescript
import PlatformDictManagement from './components/PlatformDictManagement';

// 在render部分添加：
{currentTab === 'platform-dict-management' && <PlatformDictManagement />}
```

### 4. 更新 NavManagement 组件

在导航管理表单中，将 showPlatform 改为多选下拉框：

```typescript
// 1. 加载平台字典列表
const [platformList, setPlatformList] = useState<PlatformDict[]>([]);

useEffect(() => {
  loadPlatformList();
}, []);

const loadPlatformList = async () => {
  const response = await platformDictApi.getEnabled();
  if (response.code === 200) {
    setPlatformList(response.data);
  }
};

// 2. 在表单中添加平台选择
<Form.Item
  label="显示平台"
  name="showPlatform"
  tooltip="选择该导航在哪些平台显示，不选表示在所有平台显示"
>
  <Select
    mode="multiple"
    placeholder="不选表示在所有平台显示"
    allowClear
  >
    {platformList.map(p => (
      <Select.Option key={p.routePath} value={p.routePath}>
        {p.platformName} ({p.routePath})
      </Select.Option>
    ))}
  </Select>
</Form.Item>

// 3. 处理提交时将数组转为逗号分隔字符串
const handleSubmit = async (values: any) => {
  const submitData = {
    ...values,
    showPlatform: Array.isArray(values.showPlatform)
      ? values.showPlatform.join(',')
      : values.showPlatform
  };
  // ... 提交逻辑
};

// 4. 编辑时将字符串转为数组
const handleEdit = (item: NavItem) => {
  const platformArray = item.showPlatform
    ? item.showPlatform.split(',').filter(p => p)
    : [];

  form.setFieldsValue({
    ...item,
    showPlatform: platformArray
  });
};
```

### 5. 更新 SitePublishManagement 组件

将平台类型改为下拉框选择：

```typescript
// 1. 加载平台字典
const [platformList, setPlatformList] = useState<PlatformDict[]>([]);

useEffect(() => {
  loadPlatformList();
}, []);

const loadPlatformList = async () => {
  const response = await platformDictApi.getEnabled();
  if (response.code === 200) {
    setPlatformList(response.data);
  }
};

// 2. 更新表单字段
<Form.Item
  label="关联平台"
  name="platformDictPath"
  tooltip="选择该页面显示哪个平台的导航数据，不选表示显示所有导航"
>
  <Select
    placeholder="不选表示显示所有导航"
    allowClear
  >
    {platformList.map(p => (
      <Select.Option key={p.routePath} value={p.routePath}>
        {p.platformName} ({p.routePath})
      </Select.Option>
    ))}
  </Select>
</Form.Item>
```

### 6. 更新 useNavigation Hook

根据新的平台字典逻辑更新导航加载：

```typescript
const loadData = async () => {
  // ...

  // 1. 根据路径获取 SitePublish 配置
  let sitePublish: SitePublish | null = null;
  if (location.pathname !== '/' && location.pathname !== '/admin') {
    const response = await sitePublishApi.getByRoutePath(location.pathname);
    if (response.code === 200 && response.data && response.data.enabled) {
      sitePublish = response.data;
    }
  }

  // 2. 根据配置加载导航数据
  if (sitePublish?.platformDictPath) {
    // 有平台配置，加载该平台的导航
    await loadNavItems([sitePublish.platformDictPath]);
  } else {
    // 没有平台配置，加载所有导航
    await loadNavItems([]);
  }

  // ...
};

const loadNavItems = async (platformPaths: string[]) => {
  if (platformPaths.length > 0) {
    // 调用平台过滤接口
    const response = await navigationApi.getListByPlatform(platformPaths);
    // 处理响应...
  } else {
    // 加载所有导航
    const response = await webApi.getNavsPage({ page: { pageNum: 1, pageSize: 100 } });
    // 处理响应...
  }
};
```

## 数据库迁移

需要执行的 SQL（H2 和 MySQL）：

```sql
-- 1. 创建平台字典表
CREATE TABLE platform_dict (
  id INT PRIMARY KEY AUTO_INCREMENT,
  route_path VARCHAR(100) NOT NULL UNIQUE COMMENT '路由路径',
  platform_name VARCHAR(100) NOT NULL COMMENT '平台名称',
  description VARCHAR(500) COMMENT '描述说明',
  enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
  sort INT DEFAULT 1 COMMENT '排序值'
);

CREATE INDEX idx_route_path ON platform_dict(route_path);
CREATE INDEX idx_enabled ON platform_dict(enabled);

-- 2. 修改 nav_item 表的 showPlatform 字段
ALTER TABLE nav_item MODIFY COLUMN show_platform VARCHAR(500) COMMENT '可显示的平台列表，逗号分隔';

-- 3. 修改 site_publish 表
ALTER TABLE site_publish DROP COLUMN show_platform;
ALTER TABLE site_publish ADD COLUMN platform_dict_path VARCHAR(100) COMMENT '关联的平台字典路由路径';

-- 4. 插入示例数据
INSERT INTO platform_dict (route_path, platform_name, description, enabled, sort) VALUES
('dev', '开发运维平台', '用于开发和运维团队', TRUE, 1),
('cp', '产品销售平台', '用于产品和销售团队', TRUE, 2),
('public', '公开展示页', '用于公开展示', TRUE, 3);
```

## 使用说明

1. **平台字典管理**
   - 进入管理后台 → 平台字典
   - 新增平台（如：dev、cp、public）
   - 设置平台名称和描述

2. **导航管理**
   - 编辑导航时，选择该导航在哪些平台显示
   - 可多选平台，不选表示在所有平台显示

3. **页面发布**
   - 创建页���发布配置时，选择关联的平台
   - 访问该页面时，只显示对应平台的导航

## 注意事项

1. ⚠️ 不允许创建路由路径为 `admin` 或空（根路径）的平台或页面
2. ⚠️ 删除平台字典前，请确保没有导航或页面引用该平台
3. ⚠️ 修改平台的 routePath 会影响所有引用该平台的导航和页面
