<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½å¯¼èˆªåŠ©æ‰‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: arial, sans-serif;
      background: #fff;
      min-height: 100vh;
      padding: 20px;
      color: #202124;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* æœç´¢æ æ ·å¼ */
    .search-section {
      max-width: 1200px;
      margin: 80px auto 40px;
      text-align: center;
      padding: 0 20px;
    }

    .search-box {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 20px;
    }

    .engine-select {
      padding: 11px 16px;
      border: 1px solid #dfe1e5;
      border-radius: 24px;
      font-size: 14px;
      outline: none;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
      color: #202124;
      font-family: arial, sans-serif;
    }

    .engine-select:hover {
      border-color: #dadce0;
      box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
    }

    .engine-select:focus {
      border-color: transparent;
      box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
    }

    .search-input {
      flex: 1;
      padding: 11px 16px;
      border: 1px solid #dfe1e5;
      border-radius: 24px;
      font-size: 16px;
      outline: none;
      transition: all 0.2s;
      color: #202124;
      font-family: arial, sans-serif;
    }

    .search-input:hover {
      border-color: #dadce0;
      box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
    }

    .search-input:focus {
      border-color: transparent;
      box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
    }

    .search-btn {
      padding: 11px 24px;
      background: #f8f9fa;
      color: #3c4043;
      border: 1px solid #f8f9fa;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14px;
      font-family: arial, sans-serif;
      transition: all 0.1s;
      white-space: nowrap;
    }

    .search-btn:hover {
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      background: #f8f9fa;
      border: 1px solid #dadce0;
      color: #202124;
    }

    /* åˆ†ç±»å’Œå¯¼èˆªæ ·å¼ */
    .nav-section {
      background: #fff;
      padding: 0 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .category-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 24px;
      border-bottom: 1px solid #dadce0;
      padding-bottom: 0;
      flex-wrap: wrap;
    }

    .category-tab {
      padding: 12px 16px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #5f6368;
      transition: all 0.1s;
      border-bottom: 3px solid transparent;
      font-family: arial, sans-serif;
      margin-bottom: -1px;
    }

    .category-tab:hover {
      color: #202124;
    }

    .category-tab.active {
      color: #1a73e8;
      border-bottom-color: #1a73e8;
    }

    .sites-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .site-card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid #dadce0;
      position: relative;
    }

    .site-card:hover {
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
      border-color: #dadce0;
    }

    .site-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: #f1f3f4;
      color: #5f6368;
    }

    .site-name {
      font-weight: 400;
      margin-bottom: 4px;
      color: #202124;
      font-size: 13px;
      font-family: arial, sans-serif;
    }

    .site-url {
      font-size: 11px;
      color: #5f6368;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .site-info {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f1f3f4;
      font-size: 11px;
      color: #5f6368;
      line-height: 1.4;
    }

    /* ç®¡ç†æŒ‰é’® */
    .manage-btn {
      position: fixed;
      top: 20px;
      right: 24px;
      padding: 8px 16px;
      background: transparent;
      color: #5f6368;
      border: none;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      transition: all 0.2s;
      font-family: arial, sans-serif;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .manage-btn:hover {
      background: #f8f9fa;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 24px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 10px 1px rgba(0, 0, 0, 0.14), 0 3px 14px 2px rgba(0, 0, 0, 0.12);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e8eaed;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 400;
      color: #202124;
      font-family: arial, sans-serif;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #5f6368;
      padding: 8px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      transition: background 0.1s;
    }

    .close-btn:hover {
      background: #f1f3f4;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 400;
      color: #202124;
      font-size: 13px;
      font-family: arial, sans-serif;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
      color: #202124;
      font-family: arial, sans-serif;
      transition: all 0.1s;
    }

    .form-input:hover {
      border-color: #bdc1c6;
    }

    .form-input:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 1px #1a73e8;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-family: arial, sans-serif;
      transition: all 0.1s;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
    }

    .btn-primary:hover {
      background: #1765cc;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #3c4043;
      border: 1px solid #dadce0;
    }

    .btn-secondary:hover {
      background: #f1f3f4;
    }

    .tab-buttons {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      border-bottom: 1px solid #dadce0;
    }

    .tab-button {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      color: #5f6368;
      font-size: 14px;
      font-family: arial, sans-serif;
      margin-bottom: -1px;
      transition: all 0.1s;
    }

    .tab-button:hover {
      color: #202124;
    }

    .tab-button.active {
      color: #1a73e8;
      border-bottom-color: #1a73e8;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      margin-bottom: 8px;
      background: #fff;
    }

    .list-item span {
      color: #202124;
      font-size: 14px;
      font-family: arial, sans-serif;
    }

    .delete-btn {
      background: #fff;
      color: #d93025;
      border: 1px solid #dadce0;
      padding: 6px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-family: arial, sans-serif;
      transition: all 0.1s;
    }

    .delete-btn:hover {
      background: #fef7f7;
      border-color: #d93025;
    }

    /* è´¦å·ä¿¡æ¯é”®å€¼å¯¹ */
    .account-fields {
      margin-bottom: 16px;
    }

    .account-field-item {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    .account-field-item input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
      color: #202124;
      font-family: arial, sans-serif;
    }

    .account-field-item input:focus {
      border-color: #1a73e8;
      box-shadow: 0 0 0 1px #1a73e8;
    }

    .remove-field-btn {
      background: #fff;
      color: #d93025;
      border: 1px solid #dadce0;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      transition: all 0.1s;
    }

    .remove-field-btn:hover {
      background: #fef7f7;
      border-color: #d93025;
    }

    .add-field-btn {
      background: #f8f9fa;
      color: #3c4043;
      border: 1px solid #dadce0;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-family: arial, sans-serif;
      transition: all 0.1s;
      width: 100%;
    }

    .add-field-btn:hover {
      background: #f1f3f4;
    }

    .edit-btn {
      background: #fff;
      color: #1a73e8;
      border: 1px solid #dadce0;
      padding: 6px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-family: arial, sans-serif;
      transition: all 0.1s;
      margin-right: 8px;
    }

    .edit-btn:hover {
      background: #f7fbff;
      border-color: #1a73e8;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æœç´¢åŒºåŸŸ -->
    <div class="search-section">
      <div class="search-box">
        <select class="engine-select" id="engineSelect">
          <!-- åŠ¨æ€ç”Ÿæˆé€‰é¡¹ -->
        </select>
        <input type="text" class="search-input" id="searchInput" placeholder="è¾“å…¥æœç´¢å†…å®¹...">
        <button class="search-btn" id="searchBtn">æœç´¢</button>
      </div>
    </div>

    <!-- å¯¼èˆªåŒºåŸŸ -->
    <div class="nav-section">
      <div class="category-tabs" id="categoryTabs"></div>
      <div class="sites-grid" id="sitesGrid"></div>
    </div>
  </div>

  <!-- ç®¡ç†æŒ‰é’® -->
  <button class="manage-btn" id="manageBtn">
    <span>âš™ï¸</span>
    <span>ç®¡ç†</span>
  </button>

  <!-- ç®¡ç†æ¨¡æ€æ¡† -->
  <div class="modal" id="manageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ç®¡ç†è®¾ç½®</h2>
        <button class="close-btn" id="closeModalBtn">Ã—</button>
      </div>

      <div class="tab-buttons" id="tabButtons">
        <button class="tab-button active" data-tab="category">åˆ†ç±»ç®¡ç†</button>
        <button class="tab-button" data-tab="site">ç½‘ç«™ç®¡ç†</button>
        <button class="tab-button" data-tab="engine">æœç´¢å¼•æ“</button>
        <button class="tab-button" data-tab="sync">æ•°æ®åŒæ­¥</button>
      </div>

      <!-- åˆ†ç±»ç®¡ç† -->
      <div id="categoryManage" class="tab-content">
        <div class="form-group">
          <label class="form-label">åˆ†ç±»åç§°</label>
          <input type="text" class="form-input" id="categoryName">
        </div>
        <button class="btn btn-primary" id="addCategoryBtn">æ·»åŠ åˆ†ç±»</button>
        <div id="categoryList" style="margin-top: 20px;"></div>
      </div>

      <!-- ç½‘ç«™ç®¡ç† -->
      <div id="siteManage" class="tab-content" style="display: none;">
        <div class="form-group">
          <label class="form-label">é€‰æ‹©åˆ†ç±»</label>
          <select class="form-input" id="siteCategory"></select>
        </div>
        <div class="form-group">
          <label class="form-label">ç½‘ç«™åç§°</label>
          <input type="text" class="form-input" id="siteName">
        </div>
        <div class="form-group">
          <label class="form-label">ç½‘ç«™æè¿°</label>
          <input type="text" class="form-input" id="siteDesc" placeholder="ç®€çŸ­æè¿°æ­¤ç½‘ç«™">
        </div>
        <div class="form-group">
          <label class="form-label">ç½‘ç«™å›¾æ ‡(emoji æˆ–æ–‡å­—)</label>
          <input type="text" class="form-input" id="siteIcon" placeholder="ğŸŒ">
        </div>
        <div class="form-group">
          <label class="form-label">ç½‘ç«™åœ°å€</label>
          <input type="text" class="form-input" id="siteUrl" placeholder="https://example.com">
        </div>
        <div class="form-group">
          <label class="form-label">è´¦å·ä¿¡æ¯(å¯é€‰)</label>
          <div class="account-fields" id="accountFields">
            <!-- åŠ¨æ€ç”Ÿæˆè´¦å·å­—æ®µ -->
          </div>
          <button class="add-field-btn" id="addFieldBtn">+ æ·»åŠ å­—æ®µ</button>
        </div>
        <button class="btn btn-primary" id="saveSiteBtn">æ·»åŠ ç½‘ç«™</button>
        <button class="btn btn-secondary" id="cancelEditBtn" style="display: none;">å–æ¶ˆç¼–è¾‘</button>
        <div id="siteList" style="margin-top: 20px;"></div>
      </div>

      <!-- æœç´¢å¼•æ“ç®¡ç† -->
      <div id="engineManage" class="tab-content" style="display: none;">
        <div class="form-group">
          <label class="form-label">å¼•æ“åç§°</label>
          <input type="text" class="form-input" id="engineName">
        </div>
        <div class="form-group">
          <label class="form-label">æœç´¢URL (ç”¨ {query} ä»£æ›¿æœç´¢è¯)</label>
          <input type="text" class="form-input" id="engineUrl" placeholder="https://www.google.com/search?q={query}">
        </div>
        <button class="btn btn-primary" id="addEngineBtn">æ·»åŠ æœç´¢å¼•æ“</button>
        <div id="engineList" style="margin-top: 20px;"></div>
      </div>

      <!-- æ•°æ®åŒæ­¥ -->
      <div id="syncManage" class="tab-content" style="display: none;">
        <div style="margin-bottom: 24px; padding: 16px; background: #e8f0fe; border-radius: 8px; border-left: 4px solid #1a73e8;">
          <div style="font-size: 14px; color: #202124; margin-bottom: 8px;">
            <strong>ğŸ”„ è‡ªåŠ¨äº‘ç«¯åŒæ­¥</strong>
          </div>
          <div style="font-size: 13px; color: #5f6368; line-height: 1.5;">
            å½“æ‚¨ç™»å½• Chrome/Edge è´¦å·åï¼Œæ‰€æœ‰æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ã€‚<br>
            åœ¨å…¶ä»–è®¾å¤‡ä¸Šå®‰è£…æ­¤æ’ä»¶å¹¶ç™»å½•ç›¸åŒè´¦å·ï¼Œå³å¯è‡ªåŠ¨åŒæ­¥æ‰€æœ‰è®¾ç½®ã€‚
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">æ‰‹åŠ¨å¤‡ä»½ä¸æ¢å¤</label>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="btn btn-primary" id="exportDataBtn" style="flex: 1;">
              ğŸ“¥ å¯¼å‡ºæ•°æ®
            </button>
            <button class="btn btn-secondary" id="importDataBtn" style="flex: 1;">
              ğŸ“¤ å¯¼å…¥æ•°æ®
            </button>
          </div>
          <input type="file" id="importFile" accept=".json" style="display: none;">
          <div style="font-size: 12px; color: #5f6368; margin-top: 8px;">
            å¯¼å‡ºçš„ JSON æ–‡ä»¶å¯ç”¨äºå¤‡ä»½æˆ–è¿ç§»åˆ°å…¶ä»–æµè§ˆå™¨
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">å­˜å‚¨ä¿¡æ¯</label>
          <div style="padding: 12px; background: #f8f9fa; border-radius: 4px; font-size: 13px; color: #5f6368;" id="storageInfo">
            åŠ è½½ä¸­...
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" style="color: #d93025;">å±é™©æ“ä½œ</label>
          <button class="btn" id="clearDataBtn" style="background: #fff; color: #d93025; border: 1px solid #d93025;">
            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
          </button>
          <div style="font-size: 12px; color: #5f6368; margin-top: 8px;">
            æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰åˆ†ç±»ã€ç½‘ç«™å’Œæœç´¢å¼•æ“ï¼Œä¸”ä¸å¯æ¢å¤
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // é»˜è®¤æ•°æ®
    const defaultData = {
      engines: [
        { name: 'Google', url: 'https://www.google.com/search?q={query}' },
        { name: 'Bing', url: 'https://www.bing.com/search?q={query}' },
        { name: 'Baidu', url: 'https://www.baidu.com/s?wd={query}' }
      ],
      categories: ['å¸¸ç”¨', 'å·¥ä½œ', 'å¨±ä¹'],
      sites: {
        'å¸¸ç”¨': [
          { name: 'Google', icon: 'ğŸ”', url: 'https://www.google.com', desc: 'æœç´¢å¼•æ“', accountInfo: {} },
          { name: 'GitHub', icon: 'ğŸ’»', url: 'https://github.com', desc: 'ä»£ç æ‰˜ç®¡', accountInfo: {} }
        ],
        'å·¥ä½œ': [],
        'å¨±ä¹': []
      }
    };

    let data = JSON.parse(JSON.stringify(defaultData));
    let currentEngine = 'Google';
    let currentCategory = 'å¸¸ç”¨';
    let editingCategory = null;
    let editingIndex = null;

    // åˆå§‹åŒ–
    async function init() {
      await loadData();
      renderEngines();
      renderCategories();
      renderSites();
    }

    // åŠ è½½æ•°æ®ï¼ˆä»åŒæ­¥å­˜å‚¨ï¼‰
    async function loadData() {
      try {
        // å°è¯•ä» Chrome Sync Storage åŠ è½½
        if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.sync) {
          const result = await new Promise((resolve) => {
            chrome.storage.sync.get(['navData'], resolve);
          });

          if (result.navData) {
            data = result.navData;
            console.log('âœ… æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥åŠ è½½');
            return;
          }
        }

        // é™çº§åˆ° localStorageï¼ˆç”¨äºå…¼å®¹æ€§æˆ–è¿ç§»ï¼‰
        const stored = localStorage.getItem('navData');
        if (stored) {
          data = JSON.parse(stored);
          // è¿ç§»æ•°æ®åˆ° sync storage
          await saveData();
          console.log('âœ… æ•°æ®å·²ä»æœ¬åœ°è¿ç§»åˆ°äº‘ç«¯åŒæ­¥');
          return;
        }

        // ä½¿ç”¨é»˜è®¤æ•°æ® - é‡è¦ï¼šç¡®ä¿ data åŒ…å«é»˜è®¤æ•°æ®
        data = JSON.parse(JSON.stringify(defaultData));
        await saveData();
        console.log('âœ… ä½¿ç”¨é»˜è®¤æ•°æ®');
      } catch (error) {
        console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
        // é™çº§åˆ° localStorage
        const stored = localStorage.getItem('navData');
        if (stored) {
          data = JSON.parse(stored);
        } else {
          // æœ€ç»ˆé™çº§ï¼šä½¿ç”¨é»˜è®¤æ•°æ®
          data = JSON.parse(JSON.stringify(defaultData));
        }
      }
    }

    // ä¿å­˜æ•°æ®ï¼ˆåˆ°åŒæ­¥å­˜å‚¨ï¼‰
    async function saveData() {
      try {
        // ä¿å­˜åˆ° Chrome Sync Storage
        if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.sync) {
          await new Promise((resolve, reject) => {
            chrome.storage.sync.set({ navData: data }, () => {
              if (chrome.runtime.lastError) {
                reject(chrome.runtime.lastError);
              } else {
                resolve();
              }
            });
          });
          console.log('âœ… æ•°æ®å·²åŒæ­¥åˆ°äº‘ç«¯');
        }

        // åŒæ—¶ä¿å­˜åˆ° localStorage ä½œä¸ºå¤‡ä»½
        localStorage.setItem('navData', JSON.stringify(data));
      } catch (error) {
        console.error('âŒ ä¿å­˜æ•°æ®å¤±è´¥:', error);
        // é™çº§åˆ° localStorage
        localStorage.setItem('navData', JSON.stringify(data));
      }
    }

    // ç›‘å¬æ¥è‡ªå…¶ä»–è®¾å¤‡çš„åŒæ­¥æ›´æ–°
    if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.onChanged) {
      chrome.storage.onChanged.addListener((changes, areaName) => {
        if (areaName === 'sync' && changes.navData) {
          console.log('ğŸ”„ æ£€æµ‹åˆ°æ•°æ®åŒæ­¥æ›´æ–°');
          data = changes.navData.newValue;
          renderEngines();
          renderCategories();
          renderSites();
        }
      });
    }

    // æ¸²æŸ“æœç´¢å¼•æ“
    function renderEngines() {
      const select = document.getElementById('engineSelect');
      select.innerHTML = data.engines.map(e => 
        `<option value="${e.name}" ${e.name === currentEngine ? 'selected' : ''}>${e.name}</option>`
      ).join('');
      
      // ç›‘å¬ä¸‹æ‹‰é€‰æ‹©å˜åŒ–
      select.onchange = function() {
        currentEngine = this.value;
      };
    }

    function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      const engine = data.engines.find(e => e.name === currentEngine);
      if (engine) {
        const url = engine.url.replace('{query}', encodeURIComponent(query));

        // å°è¯•ä½¿ç”¨ Chrome API åœ¨å½“å‰æ ‡ç­¾é¡µæ‰“å¼€
        if (typeof chrome !== 'undefined' && chrome.tabs && chrome.tabs.update) {
          chrome.tabs.update({ url: url });
        } else {
          // é™çº§æ–¹æ¡ˆ
          window.location.href = url;
        }
      }
    }

    // æ¸²æŸ“åˆ†ç±»
    function renderCategories() {
      const container = document.getElementById('categoryTabs');
      container.innerHTML = data.categories.map(c =>
        `<button class="category-tab ${c === currentCategory ? 'active' : ''}"
                data-category="${c}">${c}</button>`
      ).join('');

      // ç»‘å®šåˆ†ç±»ç‚¹å‡»äº‹ä»¶
      container.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          selectCategory(e.target.dataset.category);
        });
      });
    }

    function selectCategory(name) {
      currentCategory = name;
      renderCategories();
      renderSites();
    }

    // æ¸²æŸ“ç½‘ç«™
    function renderSites() {
      const container = document.getElementById('sitesGrid');
      const sites = data.sites[currentCategory] || [];

      container.innerHTML = sites.map((site, i) => {
        const accountInfoHtml = site.accountInfo && Object.keys(site.accountInfo).length > 0
          ? `<div class="site-info">${Object.entries(site.accountInfo).map(([k, v]) => `${k}: ${v}`).join('<br>')}</div>`
          : '';

        return `
          <div class="site-card" data-url="${site.url}">
            <div class="site-avatar">${site.icon}</div>
            <div class="site-name">${site.name}</div>
            ${site.desc ? `<div class="site-url">${site.desc}</div>` : ''}
            ${accountInfoHtml}
          </div>
        `;
      }).join('');

      // ç»‘å®šç½‘ç«™å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      container.querySelectorAll('.site-card').forEach(card => {
        card.addEventListener('click', () => {
          openSite(card.dataset.url);
        });
      });
    }

    function openSite(url) {
      // å°è¯•ä½¿ç”¨ Chrome API åœ¨å½“å‰æ ‡ç­¾é¡µæ‰“å¼€
      if (typeof chrome !== 'undefined' && chrome.tabs && chrome.tabs.update) {
        chrome.tabs.update({ url: url });
      } else {
        // é™çº§æ–¹æ¡ˆ
        window.location.href = url;
      }
    }

    // æ¨¡æ€æ¡†ç®¡ç†
    function openManageModal() {
      document.getElementById('manageModal').classList.add('active');
      renderManageLists();
    }

    function closeManageModal() {
      document.getElementById('manageModal').classList.remove('active');
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');

      document.getElementById('categoryManage').style.display = tab === 'category' ? 'block' : 'none';
      document.getElementById('siteManage').style.display = tab === 'site' ? 'block' : 'none';
      document.getElementById('engineManage').style.display = tab === 'engine' ? 'block' : 'none';
      document.getElementById('syncManage').style.display = tab === 'sync' ? 'block' : 'none';

      // åˆ‡æ¢åˆ°ç½‘ç«™ç®¡ç†æ—¶ï¼Œåˆå§‹åŒ–è´¦å·å­—æ®µ
      if (tab === 'site') {
        initAccountFields();
      }

      // åˆ‡æ¢åˆ°æ•°æ®åŒæ­¥æ—¶ï¼Œæ›´æ–°å­˜å‚¨ä¿¡æ¯
      if (tab === 'sync') {
        updateStorageInfo();
      }
    }

    // åˆå§‹åŒ–è´¦å·å­—æ®µ
    function initAccountFields() {
      const container = document.getElementById('accountFields');
      container.innerHTML = '';
    }

    // æ·»åŠ è´¦å·å­—æ®µ
    function addAccountField(key = '', value = '') {
      const container = document.getElementById('accountFields');
      const index = container.children.length;

      const fieldDiv = document.createElement('div');
      fieldDiv.className = 'account-field-item';
      fieldDiv.dataset.index = index;
      fieldDiv.innerHTML = `
        <input type="text" placeholder="å­—æ®µå(å¦‚: è´¦å·ã€å¯†ç )" value="${key}" class="field-key">
        <input type="text" placeholder="å­—æ®µå€¼" value="${value}" class="field-value">
        <button class="remove-field-btn" data-remove-index="${index}">Ã—</button>
      `;

      container.appendChild(fieldDiv);

      // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
      fieldDiv.querySelector('.remove-field-btn').addEventListener('click', (e) => {
        removeAccountField(e.target.dataset.removeIndex);
      });
    }

    // ç§»é™¤è´¦å·å­—æ®µ
    function removeAccountField(index) {
      const item = document.querySelector(`.account-field-item[data-index="${index}"]`);
      if (item) item.remove();
    }

    // è·å–è´¦å·ä¿¡æ¯
    function getAccountInfo() {
      const fields = document.querySelectorAll('.account-field-item');
      const accountInfo = {};

      fields.forEach(field => {
        const key = field.querySelector('.field-key').value.trim();
        const value = field.querySelector('.field-value').value.trim();
        if (key && value) {
          accountInfo[key] = value;
        }
      });

      return accountInfo;
    }

    function renderManageLists() {
      // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = data.categories.map((c, i) => `
        <div class="list-item">
          <span>${c}</span>
          <button class="delete-btn" data-action="delete-category" data-index="${i}">åˆ é™¤</button>
        </div>
      `).join('');

      // æ¸²æŸ“ç½‘ç«™é€‰æ‹©åˆ†ç±»
      const siteCategory = document.getElementById('siteCategory');
      siteCategory.innerHTML = data.categories.map(c =>
        `<option value="${c}">${c}</option>`
      ).join('');

      // æ¸²æŸ“ç½‘ç«™åˆ—è¡¨
      const siteList = document.getElementById('siteList');
      const category = siteCategory.value || data.categories[0];
      const sites = data.sites[category] || [];
      siteList.innerHTML = sites.map((s, i) => `
        <div class="list-item">
          <span>${s.icon} ${s.name}</span>
          <div>
            <button class="edit-btn" data-action="edit-site" data-category="${category}" data-index="${i}">ç¼–è¾‘</button>
            <button class="delete-btn" data-action="delete-site" data-category="${category}" data-index="${i}">åˆ é™¤</button>
          </div>
        </div>
      `).join('');

      // æ¸²æŸ“æœç´¢å¼•æ“åˆ—è¡¨
      const engineList = document.getElementById('engineList');
      engineList.innerHTML = data.engines.map((e, i) => `
        <div class="list-item">
          <span>${e.name}</span>
          <button class="delete-btn" data-action="delete-engine" data-index="${i}">åˆ é™¤</button>
        </div>
      `).join('');

      // ç»‘å®šäº‹ä»¶
      categoryList.addEventListener('click', handleManageAction);
      siteList.addEventListener('click', handleManageAction);
      engineList.addEventListener('click', handleManageAction);
    }

    function handleManageAction(e) {
      const target = e.target;
      const action = target.dataset.action;
      const index = parseInt(target.dataset.index);
      const category = target.dataset.category;

      switch(action) {
        case 'delete-category':
          deleteCategory(index);
          break;
        case 'edit-site':
          editSite(category, index);
          break;
        case 'delete-site':
          deleteSite(category, index);
          break;
        case 'delete-engine':
          deleteEngine(index);
          break;
      }
    }

    // æ·»åŠ åŠŸèƒ½
    function addCategory() {
      const name = document.getElementById('categoryName').value.trim();
      if (!name) return alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
      if (data.categories.includes(name)) return alert('åˆ†ç±»å·²å­˜åœ¨');
      
      data.categories.push(name);
      data.sites[name] = [];
      saveData();
      renderCategories();
      renderManageLists();
      document.getElementById('categoryName').value = '';
    }

    function addSite() {
      const category = document.getElementById('siteCategory').value;
      const name = document.getElementById('siteName').value.trim();
      const desc = document.getElementById('siteDesc').value.trim();
      const icon = document.getElementById('siteIcon').value.trim() || 'ğŸŒ';
      const url = document.getElementById('siteUrl').value.trim();
      const accountInfo = getAccountInfo();

      if (!name || !url) return alert('è¯·å¡«å†™ç½‘ç«™åç§°å’Œåœ°å€');

      if (!data.sites[category]) data.sites[category] = [];
      data.sites[category].push({ name, icon, url, desc, accountInfo });

      saveData();
      renderSites();
      renderManageLists();

      clearSiteForm();
    }

    function saveSite() {
      if (editingCategory !== null && editingIndex !== null) {
        // ç¼–è¾‘æ¨¡å¼
        updateSite();
      } else {
        // æ·»åŠ æ¨¡å¼
        addSite();
      }
    }

    function editSite(category, index) {
      const site = data.sites[category][index];

      editingCategory = category;
      editingIndex = index;

      // å¡«å……è¡¨å•
      document.getElementById('siteCategory').value = category;
      document.getElementById('siteName').value = site.name;
      document.getElementById('siteDesc').value = site.desc || '';
      document.getElementById('siteIcon').value = site.icon;
      document.getElementById('siteUrl').value = site.url;

      // å¡«å……è´¦å·ä¿¡æ¯
      initAccountFields();
      if (site.accountInfo && Object.keys(site.accountInfo).length > 0) {
        Object.entries(site.accountInfo).forEach(([key, value]) => {
          addAccountField(key, value);
        });
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('saveSiteBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';

      // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
      document.getElementById('siteManage').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updateSite() {
      const category = document.getElementById('siteCategory').value;
      const name = document.getElementById('siteName').value.trim();
      const desc = document.getElementById('siteDesc').value.trim();
      const icon = document.getElementById('siteIcon').value.trim() || 'ğŸŒ';
      const url = document.getElementById('siteUrl').value.trim();
      const accountInfo = getAccountInfo();

      if (!name || !url) return alert('è¯·å¡«å†™ç½‘ç«™åç§°å’Œåœ°å€');

      // å¦‚æœåˆ†ç±»æ”¹å˜ï¼Œéœ€è¦ä»æ—§åˆ†ç±»åˆ é™¤å¹¶æ·»åŠ åˆ°æ–°åˆ†ç±»
      if (category !== editingCategory) {
        data.sites[editingCategory].splice(editingIndex, 1);
        if (!data.sites[category]) data.sites[category] = [];
        data.sites[category].push({ name, icon, url, desc, accountInfo });
      } else {
        // åŒä¸€åˆ†ç±»ï¼Œç›´æ¥æ›´æ–°
        data.sites[category][editingIndex] = { name, icon, url, desc, accountInfo };
      }

      saveData();
      renderSites();
      renderManageLists();

      cancelEdit();
    }

    function cancelEdit() {
      editingCategory = null;
      editingIndex = null;

      clearSiteForm();

      document.getElementById('saveSiteBtn').textContent = 'æ·»åŠ ç½‘ç«™';
      document.getElementById('cancelEditBtn').style.display = 'none';
    }

    function clearSiteForm() {
      document.getElementById('siteName').value = '';
      document.getElementById('siteDesc').value = '';
      document.getElementById('siteIcon').value = '';
      document.getElementById('siteUrl').value = '';
      initAccountFields();
    }

    function addEngine() {
      const name = document.getElementById('engineName').value.trim();
      const url = document.getElementById('engineUrl').value.trim();
      
      if (!name || !url) return alert('è¯·å¡«å†™å¼•æ“åç§°å’ŒURL');
      if (!url.includes('{query}')) return alert('URLå¿…é¡»åŒ…å« {query}');
      
      data.engines.push({ name, url });
      saveData();
      renderEngines();
      renderManageLists();
      
      document.getElementById('engineName').value = '';
      document.getElementById('engineUrl').value = '';
    }

    // åˆ é™¤åŠŸèƒ½
    function deleteCategory(index) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»åŠå…¶æ‰€æœ‰ç½‘ç«™?')) return;
      const category = data.categories[index];
      data.categories.splice(index, 1);
      delete data.sites[category];
      if (currentCategory === category) {
        currentCategory = data.categories[0];
      }
      saveData();
      renderCategories();
      renderSites();
      renderManageLists();
    }

    function deleteSite(category, index) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç½‘ç«™?')) return;
      data.sites[category].splice(index, 1);
      saveData();
      renderSites();
      renderManageLists();
    }

    function deleteEngine(index) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤æœç´¢å¼•æ“?')) return;
      data.engines.splice(index, 1);
      saveData();
      renderEngines();
      renderManageLists();
    }

    // æ•°æ®åŒæ­¥åŠŸèƒ½

    // å¯¼å‡ºæ•°æ®
    function exportData() {
      try {
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10);
        link.href = url;
        link.download = `oasis-backup-${timestamp}.json`;
        link.click();
        URL.revokeObjectURL(url);
        alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
      } catch (error) {
        console.error('å¯¼å‡ºå¤±è´¥:', error);
        alert('âŒ æ•°æ®å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // å¯¼å…¥æ•°æ®
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const importedData = JSON.parse(e.target.result);

          // éªŒè¯æ•°æ®æ ¼å¼
          if (!importedData.engines || !importedData.categories || !importedData.sites) {
            throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          }

          if (!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰è®¾ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
            event.target.value = '';
            return;
          }

          data = importedData;
          await saveData();
          renderEngines();
          renderCategories();
          renderSites();
          renderManageLists();

          alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼');
        } catch (error) {
          console.error('å¯¼å…¥å¤±è´¥:', error);
          alert('âŒ æ•°æ®å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
        }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    // æ›´æ–°å­˜å‚¨ä¿¡æ¯
    async function updateStorageInfo() {
      try {
        const dataSize = new Blob([JSON.stringify(data)]).size;
        const sitesCount = Object.values(data.sites).reduce((sum, arr) => sum + arr.length, 0);

        let syncStatus = 'âŒ æœªå¯ç”¨';
        let quota = 'æœªçŸ¥';

        if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.sync) {
          syncStatus = 'âœ… å·²å¯ç”¨';

          // è·å–å­˜å‚¨é…é¢ä¿¡æ¯
          try {
            const QUOTA_BYTES = chrome.storage.sync.QUOTA_BYTES || 102400;
            const usagePercent = ((dataSize / QUOTA_BYTES) * 100).toFixed(1);
            quota = `${(dataSize / 1024).toFixed(2)} KB / ${(QUOTA_BYTES / 1024).toFixed(0)} KB (${usagePercent}%)`;
          } catch (e) {
            quota = `${(dataSize / 1024).toFixed(2)} KB`;
          }
        }

        const infoHtml = `
          <div style="display: grid; gap: 8px;">
            <div><strong>äº‘ç«¯åŒæ­¥çŠ¶æ€:</strong> ${syncStatus}</div>
            <div><strong>æ•°æ®å¤§å°:</strong> ${quota}</div>
            <div><strong>åˆ†ç±»æ•°é‡:</strong> ${data.categories.length} ä¸ª</div>
            <div><strong>ç½‘ç«™æ•°é‡:</strong> ${sitesCount} ä¸ª</div>
            <div><strong>æœç´¢å¼•æ“:</strong> ${data.engines.length} ä¸ª</div>
          </div>
        `;

        document.getElementById('storageInfo').innerHTML = infoHtml;
      } catch (error) {
        console.error('æ›´æ–°å­˜å‚¨ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('storageInfo').textContent = 'âŒ è·å–ä¿¡æ¯å¤±è´¥';
      }
    }

    // æ¸…ç©ºæ‰€æœ‰æ•°æ®
    async function clearAllData() {
      if (!confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
        return;
      }

      if (!confirm('è¯·å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰åˆ†ç±»ã€ç½‘ç«™å’Œæœç´¢å¼•æ“å—ï¼Ÿ')) {
        return;
      }

      try {
        data = JSON.parse(JSON.stringify(defaultData));
        await saveData();

        renderEngines();
        renderCategories();
        renderSites();
        renderManageLists();
        updateStorageInfo();

        alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼Œå·²æ¢å¤ä¸ºé»˜è®¤è®¾ç½®');
      } catch (error) {
        console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
        alert('âŒ æ¸…ç©ºæ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // å›è½¦æœç´¢
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    // ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
    function bindEventListeners() {
      // æœç´¢æŒ‰é’®
      document.getElementById('searchBtn').addEventListener('click', performSearch);

      // ç®¡ç†æŒ‰é’®
      document.getElementById('manageBtn').addEventListener('click', openManageModal);
      document.getElementById('closeModalBtn').addEventListener('click', closeManageModal);

      // Tab åˆ‡æ¢
      document.getElementById('tabButtons').addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-button')) {
          switchTab(e.target.dataset.tab);
        }
      });

      // åˆ†ç±»ç®¡ç†
      document.getElementById('addCategoryBtn').addEventListener('click', addCategory);

      // ç½‘ç«™ç®¡ç†
      document.getElementById('addFieldBtn').addEventListener('click', () => addAccountField());
      document.getElementById('saveSiteBtn').addEventListener('click', saveSite);
      document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

      // æœç´¢å¼•æ“ç®¡ç†
      document.getElementById('addEngineBtn').addEventListener('click', addEngine);

      // æ•°æ®åŒæ­¥
      document.getElementById('exportDataBtn').addEventListener('click', exportData);
      document.getElementById('importDataBtn').addEventListener('click', () => {
        document.getElementById('importFile').click();
      });
      document.getElementById('importFile').addEventListener('change', importData);
      document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

      // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
      document.getElementById('manageModal').addEventListener('click', (e) => {
        if (e.target.id === 'manageModal') {
          closeManageModal();
        }
      });
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        bindEventListeners();
        init();
      });
    } else {
      bindEventListeners();
      init();
    }
  </script>
</body>
</html>